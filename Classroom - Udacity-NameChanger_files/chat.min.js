'use strict';angular.module("utility").directive("allSetModal",["cacheVersion","modal",function(c){return{templateUrl:"/templates/chat/all_set_modal.html?"+c}}]);angular.module("utility").filter("array",function(){return function(c){return _.values(c)}});angular.module("utility").directive("chatBox",["cacheVersion","chatDataStore","currentUser","$timeout",function(c,f,b,d){return{templateUrl:"/templates/chat/chat_box.html?"+c,scope:{recipientId:"@"},link:function(a,b){var c=_.throttle(function(){d(angular.noop)},1E3);a.recipient=f.getChannelObjectFromId(a.recipientId);a.focused=!0;a.mention={mentionState:!1};a.jabberIdToUserObjectMap={};a.newMessage={messageText:null};a.userList={show:!1};a.mentionText=null;var j=function(){var a=b.find(".chat-box-messages")[0];
a&&(a.scrollTop=a.scrollHeight)};_.defer(j);a.$watchCollection("recipient.conversation",function(){a.recipient.minimized||(f.markAllMessagesRead(a.recipient),_.defer(j))});b.find(".chat-box-input").keyup(function(b){13===b.which?a.sendMessage(a.recipient.id,a.newMessage.messageText):k()});a.$watch("recipient.minimized",function(){a.recipient.minimized||_.defer(j)});var e=/@\w*$/,k=_.throttle(function(){if(a.newMessage.messageText){var b=a.newMessage.messageText.match(e);if(b){0<b[0].length&&(a.mentionText=
b[0].slice(1));a.mention.mentionState=!0;return}}a.mention.mentionState=!1;a.mentionText=null},500);a.toggleMinimizeOnHeaderBarClick=function(){a.recipient.minimized&&a.toggleMinimize()};a.toggleMinimize=function(){a.recipient.minimized?(a.recipient.minimized=!1,f.unminimizeChannel(a.recipient)):a.recipient.minimized=!0};a.isCode=function(a){return"/code"===a.split(" ")[0]};var l=function(a,b){var d=a.split(b);return 1<d.length?d.slice(0,d.length-1).join(b):a};a.getNickNameFromUserId=function(a){if(a)return l(a,
"-")};a.getUserNameForDisplayNextToMessage=function(b){if(b){var d=l(b,"-");return a.isStaff(b)?d+" (staff)":d}};a.getUserFromJabberId=function(a){if(a)return l(a,"@")};a.shortenName=function(a){return a&&17<a.length?a.slice(0,14)+"...":a};a.getCodeSnippet=function(a){return a.slice(6)};a.placeUrlsInLinkTag=function(a){return a.replace(/(http[s]?:\/\/(www\.)?|www\.){1}([0-9A-Za-z-\.@:%_+~#=]+)+((\.[a-zA-Z]{2,3})+)(\/(.)*)?(\?(.)*)?/g,function(a){return"<a target='_blank' href=\""+a+'">'+a+"</a>"})};
a.mentionParticipant=function(d){d="@"+d+" ";a.newMessage.messageText||(a.newMessage.messageText="");if(null!==a.mentionText)a.newMessage.messageText=a.newMessage.messageText.replace(e,d),a.mention.mentionState=!1;else{var c=b.find(".chat-box-input")[0].selectionStart;a.newMessage.messageText=a.newMessage.messageText.slice(0,c)+d+a.newMessage.messageText.slice(c+1)}a.mentionText=null;a.userList.show=!1};a.isStaff=function(a){return a&&"staff.udacity.com"===_.last(a.split("@"))};a.sendMessage=function(b,
d){f.isRoom(b)&&f.sendRoomChat(b,d);a.newMessage.messageText=null;a.mention={mentionState:!1};c()};a.closeChat=function(){f.removeFromOpenChannels(f.getOpenChannels(),a.recipientId)}}}}]);angular.module("utility").service("chatDataStore",["chatServer","$timeout","currentUser","chatForm","dateTime","$log","notifications",function(c,f,b,d,a,h,i){var j=!1,e={roster:{users:{},rooms:{}},rooms:{},users:{},openChannels:{},courseCohortRooms:{},editedRoom:{currentlyEditing:{}},notifications:{hasUnreadMessages:!1}},k={nd001:"public"},l=_.throttle(function(){f(angular.noop)},1E3),n=function(a){return function(){var b=Array.prototype.slice.call(arguments,0);a.apply(this,b);l()}},m=function(a){try{a()}catch(b){h.error(b)}},
g={init:function(){j||(j=!0,c.startChat(k),c.roomStream.subscribe(function(a){m(function(){g.addToRooms(a)})},function(a){h.error("error getting rooms",a)},function(){}),c.directChatStream.subscribe(function(a){m(function(){g.addMessageToConversation(g.getUserInfo(a.from),a,!1)})},function(a){h.error(a)}),c.roomChatStream.subscribe(function(a){m(function(){g.addMessageToConversation(g.getRoomInfo(a.roomId),a,!0)})},function(a){h.error(a)}),c.roomPresenceStream.subscribe(function(a){m(function(){g.updateRoomParticipants(g.getRoomFromPresence(a),
a)})},function(a){h.error(a)}),c.roomJoinedStream.subscribe(function(p){m(function(){var b=g.getRoomFromPresence(p);b?b.joinedTime=a.getCurrent():h.warn("room not yet added")})},function(a){h.error(a)},function(){h.warn("room joined stream over")}),c.errorStream.subscribe(function(a){h.error(a)},function(a){h.error(a)}))},getChatDataObject:function(){return e},getRooms:function(){return e.rooms},getRoomFromPresence:function(a){return g.getRoomInfo(a.roomId)},getBookmarks:function(){return e.roster.rooms},
getCourseCohortRooms:function(){return e.courseCohortRooms},getEditedRoom:function(){return e.editedRoom},getNotifications:function(){return e.notifications},getOpenChannels:function(){return e.openChannels},setRooms:function(a){n(function(){e.rooms=a})()},setCourseCohortRooms:function(a){n(function(){e.courseCohortRooms=a})()},setBookmarks:function(a){n(function(){e.roster.rooms=a})()},setOpenChannels:function(a){n(function(){e.openChannels=a})},setNotifications:function(a){n(function(){e.notifications.hasUnreadMessages=
a})()},setEditedRoom:function(a){n(function(){e.editedRoom.currentlyEditing=g.getRoomInfo(a)})()},setEmptyConversation:function(a){return _.extend(a,{conversation:[]})},getChannelObjectFromId:function(a){return g.isRoom(a)?g.getRoomInfo(a):g.getUserInfo(a)},isRoom:function(a){return c.isRoomId(a)},getRoomsByPurpose:function(a){return _.chain(g.getBookmarks()).map(function(a,b){return g.getRoomInfo(b)}).filter(function(b){return b&&b.purpose===a}).value()},getRoomsForCourseAndCohort:function(a,b){var d=
g.getCourseCohortRooms();if(d[a]&&d[a][b])return d[a][b]},activateChannel:function(a){g.setOpenChannels(g.addToOpenChannels(a));a=g.getChannelObjectFromId(a);a.conversation||g.setEmptyConversation(a);g.markAllMessagesRead(a)},addToOpenChannels:function(a){e.openChannels[a]=1;l()},joinRoom:function(a){c.joinRoom(a.id);g.saveBookmark(_.pick(a,"name","id"))},removeFromOpenChannels:function(a,b){delete a[b];l();return a},getConversation:function(a){return a.conversation},getConversationLength:function(a){return g.getConversation(a).length},
removeBookmarkObject:function(a,b){delete a[b];return a},removeBookmark:function(a,b){g.removeBookmarkObject(a,b);c.fetchRoomBookmarks().subscribe(function(a){m(function(){c.uploadRoomBookmarks(_.filter(a,function(a){return a.id!==b}))})});return a},getRoomInfo:function(a){if(a in g.getRooms())return g.getRooms()[a];var b=_.find(_.keys(g.getRooms()),function(b){if(a&&b)return b.toLowerCase()===a.toLowerCase()});return b?g.getRooms()[b]:null},getUserInfo:function(a){if(a in e.users)return e.users[a];
var b=_.find(_.keys(e.users),function(b){return b.toLowerCase()===a.toLowerCase()});if(b)return e.users[b]},createMessageObject:function(a,b){return{message:b,lineNumber:g.getConversationLength(a),resolved:b.date>a.joinedTime?!1:!0}},addMentions:function(a,d){var c=[];d.body.match("@"+b.get("jabber_id").split("@")[0])&&a.mentions&&(c=_.union(a.mentions,[g.createMessageObject(a,d)]));return _.extend(a,{mentions:c})},updateMessagesRead:function(a,b){if(a.joinedTime>b.date)return _.extend(a,{messagesRead:a.messagesRead?
a.messagesRead+1:1});if(!(a.id in g.getOpenChannels())||a.minimized)g.setNotifications(!0),i.createNotification("chat",a.name+": New Message",b.body);return a},addToConversation:function(a,b){return _.extend(a,{conversation:_.union(a.conversation||[],[b])})},sendRoomChat:function(a,b){c.sendRoomChat(a,b)},addMessageToConversation:function(a,b,d){n(function(){if(a)return d?g.updateMessagesRead(g.addMentions(g.addToConversation(a,b),b),b):g.updateMessagesRead(g.addToConversation(a,b),b);h.warn("received message from sender that is not recognized",
b)})()},processUnavailablePresence:function(a,b){return g.removeParticipant(a,b.user)},removeParticipant:function(a,b){delete a.participants[b];a.numOccupants=_.size(a.participants);return a},createParticipant:function(a){return{id:a.user,status:a.status,affiliation:a.affiliation,role:a.role,domain:a.domain}},processAvailablePresence:function(a,b){a.participants[b.user]=g.createParticipant(b);a.numOccupants=_.size(a.participants);var d=_.object([b.user],[g.createParticipant(b)]);_.defer(l);return _.extend(a,
{participants:_.extend(a.participants||{},d),numOccupants:_.size(a.participants)})},createEmptyRoom:function(){return{category:"conference",cohort:"",conversation:[],course:"",description:"",id:"",name:"",numOccupants:0,purpose:"",type:"text"}},createRoomFromSelfPresence:function(a){e.rooms[a.roomId]=g.createEmptyRoom();return e.rooms[a.roomId]},updateRoomParticipants:function(a,b){if(!a)if("owner"===b.affiliation&&b.isCurrentUser)a=g.createRoomFromSelfPresence(b);else{h.warn("id not found for given presence element",
b);return}a.participants=a.participants||{};if("unavailable"===b.type)return g.processUnavailablePresence(a,b);if("unavailable"!==b.type)return g.processAvailablePresence(a,b)},leaveAllRooms:function(){_.forEach(g.getBookmarks(),function(a){c.leaveRoom(a.id)})},uploadRoomBookmarks:function(a){c.uploadRoomBookmarks(a);return g.setBookmarks(a)},setRoomMinimized:function(a){return _.extend(a,{minimized:!0})},addRoomObject:function(a,b){("General Discussion"===b.name||"Projects"===b.name)&&g.joinRoom(b);
return _.extend(a,_.object([b.id],[b]))},addRoomToCourseCohortRooms:function(a,b,d,c){var e=c.id;a[b]=a[b]||{};a[b][d]=a[b][d]||{};a[b][d][e]=c;return a},addToRooms:function(a){var a=g.setRoomMinimized(a),b=g.getRoomInfo(a.id);b&&(a=_.extend(b,a),g.removeRoomObject(g.getRooms(),b.id));g.setRooms(g.addRoomObject(g.getRooms(),a));g.setCourseCohortRooms(g.addRoomToCourseCohortRooms(g.getCourseCohortRooms(),a.course,a.cohort,a));a.isBookmarked&&(c.joinRoom(a.id),g.setBookmarks(g.addBookmark(g.getBookmarks(),
a.id)))},addBookmark:function(a,b){return _.extend(a,_.object([b],[1]))},saveBookmark:function(a){if(a.id){var b=g.addBookmark(g.getBookmarks(),a.id);c.fetchRoomBookmarks().subscribe(function(b){_.find(b,function(b){return b.id===a.id})||c.uploadRoomBookmarks(_.union(b,[a]))});return b}},editRoom:function(a,b){c.editRoom(a,b).subscribe(function(a){m(function(){d.setRoomEditSucceeded();g.addToRooms(a)})},function(a){m(function(){h.warn("room was not edited");d.setRoomEditFailed();h.error(a)})})},createRoom:function(a,
b,e,l){return c.createCustomRoom(a,b,e,l).subscribe(function(a){m(function(){g.saveBookmark(a);d.setRoomCreationSucceeded()})},function(a){h.warn("room was not created");d.setRoomCreationFailed();h.error(a)})},leaveRoom:function(a){g.setBookmarks(g.removeBookmark(g.getBookmarks(),a.id));c.leaveRoom(a.id)},hasBookmark:function(a){return g.getBookmarks()[a]},pruneOpenChannels:function(a){if(a&&0<=a)for(;_.size(g.getOpenChannels())>a;){var b=_.first(_.keys(g.getOpenChannels()));g.setOpenChannels(g.removeFromOpenChannels(g.getOpenChannels(),
b))}},markNonMentioningMessagesAsRead:function(a){return _.extend(a,{messagesRead:g.getConversationLength(a)})},markMentioningMessagesAsRead:function(a){return _.extend(a,{mentions:_.map(a.mentions,function(a){return _.extend(a,{resolved:!0})})})},markAllMessagesRead:function(a){return a.mentions?g.markNonMentioningMessagesAsRead(g.markMentioningMessagesAsRead(a)):g.markNonMentioningMessagesAsRead(a)},unminimizeChannel:function(a){n(function(){_.extend(g.markAllMessagesRead(a),{minimized:!1});g.setNotifications(!1)})()},
isInOpenChannels:function(a){return g.getOpenChannels()[a.id]},removeFromCourseCohortRooms:function(a,b,d,c){a[b]&&a[b][d]&&delete a[b][d][c];return a},removeRoomObject:function(a,b){delete a[b];delete a[b.toLowerCase()];return a},deleteRoom:function(a){var b=g.getRoomInfo(a);c.deleteRoom(a,b.course,b.cohort);g.setBookmarks(g.removeBookmark(g.getBookmarks(),b.id));g.setCourseCohortRooms(g.removeFromCourseCohortRooms(g.getCourseCohortRooms(),b.course,b.cohort,a));g.setRooms(g.getRooms(),g.removeRoomObject(g.getRooms(),
a));g.setOpenChannels(g.removeFromOpenChannels(g.getOpenChannels(),a))}};return g}]);angular.module("utility").service("chatForm",["$timeout",function(c){var f=function(){return{roomName:!1,description:!1,type:!1,errorMessages:[]}},b=function(){return{createSucceeded:null,editSucceeded:null}},d=_.throttle(function(){c(angular.noop)},1E3),a={invalidFields:{data:f()},submissionResults:{data:b()},isSubmissionSuccess:function(){return a.submissionResults.data.createSucceeded||a.submissionResults.data.editSucceeded},createSubmissionSucceeded:function(){return a.submissionResults.data.createSucceeded},
createSubmissionFailed:function(){return!1===a.submissionResults.data.createSucceeded},editSubmissionSucceeded:function(){return a.submissionResults.data.editSucceeded},editSubmissionFailed:function(){return!1===a.submissionResults.data.editSucceeded},hasNewSubmissionResults:function(){return null!==a.submissionResults.data.createSucceeded||null!==a.submissionResults.data.editSucceeded},clearSubmissionResults:function(){a.submissionResults.data=b()},resetInvalidFields:function(){a.invalidFields.data=
f()},setRoomCreationSucceeded:function(){a.clearSubmissionResults();a.submissionResults.data.createSucceeded=!0},setRoomCreationFailed:function(){a.clearSubmissionResults();a.submissionResults.data.createSucceeded=!1},setRoomEditSucceeded:function(){a.clearSubmissionResults();a.submissionResults.data.editSucceeded=!0},setRoomEditFailed:function(){a.clearSubmissionResults();a.submissionResults.data.editSucceeded=!1},checkForInvalidFields:function(b,c,f){var e=_.some([b,c,f],function(a){return!a});
a.invalidFields.data.errorMessages=[];var k=/^[\w\s\!\?,\.\-_\(\)]*$/;a.resetInvalidFields();if(!b||40<b.length)a.invalidFields.data.roomName=!0,b?b.match(k)?a.invalidFields.data.errorMessages.push("Group name must be less than 40 characters"):a.invalidFields.data.errorMessages.push("Invalid characters used in name. Please use alphanumeric symbols!"):a.invalidFields.data.errorMessages.push("Missing group name"),e=!0;c?c.match(k)||(a.invalidFields.data.errorMessages.push("Invalid characters used in description. Please use alphanumeric symbols!"),
e=!0):(a.invalidFields.data.description=!0,a.invalidFields.data.errorMessages.push("Missing group description"),e=!0);f||(a.invalidFields.data.type=!0,a.invalidFields.data.errorMessages.push("Missing group type"),e=!0);d();return e}};return a}]);angular.module("utility").directive("chatGroupListModal",["cacheVersion","chatDataStore","modal","chatForm","currentUser",function(c,f,b,d,a){return{templateUrl:"/templates/chat/chat_group_list_modal.html?"+c,link:function(b){b.selectedCourse="nd001";b.selectedCohort="public";b.submissionResults=d.submissionResults;b.createSubmissionSucceeded=d.createSubmissionSucceeded;b.createSubmissionFailed=d.createSubmissionFailed;b.editSubmissionSucceeded=d.editSubmissionSucceeded;b.editSubmissionFailed=d.editSubmissionFailed;
b.submissionSuccess=d.isSubmissionSuccess;b.newSubmissionResults=d.hasNewSubmissionResults;b.getNumParticipants=function(a){return _.size(a.participants)};b.isOwner=function(b){var d=a.get("jabber_id");if(b.participants&&d in b.participants)return"owner"===b.participants[d].affiliation};b.joinAndBookmarkGroup=function(a){f.joinRoom(a)};b.deleteGroup=function(a){f.deleteRoom(a)};b.getGroupsOfType=function(a,b,d){return(b=f.getRoomsForCourseAndCohort(b,d))?_.filter(b,function(b){return b.purpose===
a}):null};b.isInBookmarks=function(a){return f.hasBookmark(a.id)};b.leaveGroupAndRemoveBookmark=function(a){f.leaveRoom(a)}}}}]);angular.module("utility").directive("chatPanel",["cacheVersion","chatDataStore","currentUser","fetchDiscourseLink","$window","notifications",function(c,f,b,d,a,h){return{templateUrl:"/templates/chat/chat_panel.html?"+c,link:function(c){c.purposes=["topic"];c.userName=b.get("nickname")||b.get("first_name");c.getGroupsByPurpose=f.getRoomsByPurpose;d().then(function(a){c.forumLink=a});c.notificationsMuted=!1;c.toggleNotifications=function(){h.toggleMuteSettings("chat");c.notificationsMuted=!c.notificationsMuted};
c.openForum=function(){c.forumLink&&a.open(c.forumLink)};c.openNdPortal=function(){a.open("/course/nd001")};c.numBookmarks=function(){return _.size(f.getBookmarks())};c.getMaxNumberOfChatBoxes=function(){return 992<$(a).width()?2:1};var j=function(){_.size(f.getOpenChannels())>=c.getMaxNumberOfChatBoxes()&&f.pruneOpenChannels(c.getMaxNumberOfChatBoxes())},e=function(){j()};$(a).resize(e);c.$on("$destroy",function(){$(a).off("resize",e)});c.joinGroup=function(a){f.isInOpenChannels(a)||(f.hasBookmark(a.id)||
f.saveBookmark({id:a.id,name:a.name}),f.activateChannel(a.id),j());f.unminimizeChannel(a)};c.hasUnresolvedMentions=function(a){return!a.mentions?!1:_.some(a.mentions,function(a){return!a.resolved})}}}}]);angular.module("utility").service("chatServer",["chatServerHelper","strophe","currentUser","dateTime","$log",function(c,f,b,d,a){var h=null,i,j,e={startChat:function(k){e.getConnection()||(h=f.createXmppServerConnection());e.connectionSubject=new Rx.BehaviorSubject;var l=function(d){var d=d||1,c=2E3*d;e.getConnection().connect(b.get("jabber_id"),b.get("external_service_password"),function(b){var h=f.getConnectionStatus(b);e.connectionSubject.onNext(h);"disconnected"===f.getConnectionStatus(b)&&(a.warn("attempting to reconnect. Attempt number",
d),e.getConnection().disconnect(),a.warn("resetting connection"),e.getConnection().reset(),_.delay(l,c,d+1))})};l();e.connectionStream=e.connectionSubject.asObservable();e.connectionStream.subscribe(function(a){"connected"===a&&e.getConnection().send(f.createAvailablePresence())},function(a){console.error(a)},function(){});j=e.connectionStream.filter(function(a){return"connected"===a}).take(1);i=Rx.Observable.create(function(a){e.getConnection().addHandler(function(b){a.onNext(b);return!0},null,null,
null,null,null,null)}).publish();e.directChatStream=i.filter(c.filterDirectChatStanzas).map(c.mapDirectChatXmlToJson);e.roomChatStream=i.filter(c.filterRoomChatStanzas).map(c.mapRoomChatXmlToJson);e.roomPresenceStream=i.filter(c.filterRoomPresenceStanzas).map(c.mapRoomPresenceXmlToJson).publish();e.roomJoinedStream=e.roomPresenceStream.filter(c.filterRoomJoinedJson).map(function(a){return _.extend(a,{joinedTime:d.getCurrent()})});e.roomPresenceStream.connect();e.globalPresenceStream=i.filter(c.filterGlobalPresenceStanzas).map(c.mapGlobalPresenceXmlToJson);
e.roomJoinedFailedStream=i.filter(c.filterRoomJoinedFailedStanza).map(c.mapRoomJoinedFailedXmlToJson).subscribe(function(a){e.leaveRoom(a.id);_.delay(e.joinRoom,5E3,a.id)});e.errorStream=i.filter(c.filterErrorStanzas).map(c.mapErrorXmlToJson);e.roomStream=j.flatMap(function(){_.forEach(k,function(a,b){var d=c.createPathString(b,a);e.subscribeToPubsubNode(d)});return e.fetchRoomStream(k)});i.connect()},isRoomId:function(a){return f.isRoomId(a)},fetchRoomStream:function(a){return Rx.Observable.merge(_.map(a,
function(a,b){return e.fetchAllRoomInfoForCourseAndCohort(a,b)}))},fetchAllRoomInfoForCourseAndCohort:function(a,b){var d=c.createPathString(b,a),h=e.getNewRoomStreamAtPathWithBookmarkInfo(d),d=e.fetchRoomsAtPathWithBookmarkInfo(d);return Rx.Observable.merge(d,h).flatMap(function(a){return Rx.Observable.merge(_.map(a,e.refreshRoomInfo))})},pruneBookmarks:function(a,b){if(0<_.size(a)){var d=_.filter(b,function(b){return _.contains(_.map(a,function(a){return a.id}),b.id)});e.uploadRoomBookmarks(d)}},
refreshRoomInfo:function(a){return Rx.Observable.onErrorResumeNext(e.fetchRoomInfoFromRoomId(a.id),Rx.Observable.just()).take(1).map(function(b){return _.extend(a,b)})},subscribeToPubsubNode:function(b){return e.createIqResponseObservable(f.subscribeToPubsubNode(b)).subscribe(function(){},function(b){a.error("subscription failed",b)})},getConnection:function(){return h},pauseChat:function(){e.getConnection()&&e.getConnection().pause()},endChat:function(){e.getConnection()&&(e.getConnection().send(f.createUnavailablePresenceElement()),
e.getConnection().disconnect())},resumeChat:function(){e.getConnection()?e.getConnection().resume():e.startChat()},sendIndividualChat:function(a,b){if(e.getConnection()){var d=f.createDirectMessageElement(a,b);e.getConnection().send(d);return c.mapDirectChatXmlToJson(d)}return null},sendRoomChat:function(a,b){if(e.getConnection()){var d=f.createRoomChatMessageElement(a,b);e.getConnection().send(d);return c.mapRoomChatXmlToJson(d)}return null},joinRoom:function(a){e.getConnection().send(f.createJoinRoomPresenceElement(a))},
leaveRoom:function(a){e.getConnection().send(f.createLeaveRoomPresenceElement(a))},uploadRoomBookmarks:function(a){return e.createIqResponseObservable(f.createUploadBookmarksIqElement(a)).subscribe(function(){},function(a){console.error("bookmarks not saved",a)})},deleteBookmark:function(a,b){e.uploadRoomBookmarks(_.filter(a,function(a){return!_.isEqual(a,b)}))},deleteRoom:function(b,d,h){d=c.createPathString(d,h);e.createIqResponseObservable(f.createDeleteRoomIqElement(b)).subscribe(function(){},
function(b){a.error("deleting room failed",b)});e.createIqResponseObservable(f.createDeletePubsubItemElement(d,b)).subscribe(function(){},function(b){a.error("deleting pubsub room failed",b)})},fetchRoomBookmarks:function(){return Rx.Observable.onErrorResumeNext(e.createIqResponseObservable(f.createGetBookmarksIqElement()).doOnError(function(a){c.filterItemNotFoundStanza(a)&&e.uploadRoomBookmarks([])}).map(c.mapBookmarksXmlToJson),Rx.Observable.just([])).take(1)},fetchRoomInfoFromRoomId:function(a){return e.createIqResponseObservable(f.createRoomInfoQuery(a)).map(c.mapRoomInfoQueryResponseXmlToJson)},
fetchOpenRooms:function(){return Rx.Observable.create(function(a){e.getConnection().sendIQ(f.createOpenRoomsQuery(),function(b){a.onNext(b);a.onCompleted()},function(a){console.warn(a)})}).take(1).map(c.mapOpenRoomsXmlToJson)},createRoom:function(a,b){var d=i.filter(c.filterRoomCreatedStanzas(a)).take(1).flatMap(b);e.getConnection().send(f.createNewRoomPresenceElement(a));return d},createRoomConfigurationStream:function(a){return e.createIqResponseObservable(f.createRequestConfigFormQueryElement(a))},
createCustomRoom:function(a,b,d,h){var g=c.createPathString(b,d),b=f.getRoomJabberIdFromRoomName(a.roomName);return e.createRoom(b,e.configureRoom(a,b)).do(function(a){a&&e.saveRoomAtPath(g,h,a)}).flatMap(function(a){return e.refreshRoomInfo({id:a})})},editRoom:function(a,b){return e.configureRoom(a,b).flatMap(function(a){if(a)return e.refreshRoomInfo({id:a})})},createIqResponseObservable:function(a){return Rx.Observable.create(function(b){e.getConnection().sendIQ(a,function(a){b.onNext(a);b.onCompleted()},
function(a){b.onError(a);b.onCompleted()})}).take(1)},saveRoomAtPath:function(b,d,c){return e.createIqResponseObservable(f.createUploadRoomAccessIqElement(b,d,c)).subscribe(function(){},function(b){a.error("room not saved",b)})},configureRoom:function(a,b){return e.createRoomConfigurationStream(b).flatMap(function(d){return c.filterNoConfigPossibleStanza(d,b)?Rx.Observable.throw(Error("configurations not allowed")):Rx.Observable.onErrorResumeNext(e.createIqResponseObservable(f.createNewConfiguredRoomQueryElement(a,
b)),Rx.Observable.just()).take(1).map(c.getConfiguredRoomId(b))})},createConfiguredNode:function(b){return e.createIqResponseObservable(f.createConfiguredNodeElement(b)).subscribe(function(){e.subscribeToPubsubNode(b)},function(b){a.error("node creation failed",b)})},fetchRoomsAtPath:function(a){var b=f.createGetRoomAtNodesIqElement(a);return Rx.Observable.onErrorResumeNext(e.createIqResponseObservable(b).doOnError(function(b){c.filterItemNotFoundStanza(b)&&e.createConfiguredNode(a)}).map(c.mapPubSubRoomAtNodesResult),
Rx.Observable.just([])).take(1)},fetchRoomsAtPathWithBookmarkInfo:function(a){return e.fetchRoomsAtPath(a).combineLatest(e.fetchRoomBookmarks(),function(a,b){return{roomList:a,bookmarkList:b}}).take(1).do(function(a){e.pruneBookmarks(a.roomList,a.bookmarkList)}).map(c.combineRoomAndBookmarkLists)},getNewRoomStreamAtPath:function(a){return i.filter(c.filterPubSubUpdateForNode(a)).filter(c.filterPubsubUpdateHasRoomNodeUpdate).map(c.mapPubSubRoomNodeUpdate)},getNewRoomStreamAtPathWithBookmarkInfo:function(a){return e.getNewRoomStreamAtPath(a).map(function(a){return _.map(a,
function(a){return _.extend(a,{isBookmarked:!1})})})},createDefaultRoom:function(a){var b=f.getRoomJabberIdFromRoomName(a);return e.createRoom(b,function(){return Rx.Observable.fromCallback(e.getConnection().sendIQ)(f.createNewInstantRoomQueryElement(a)).map(function(a){return"result"===a.getAttribute("type")})})},revokeVoice:function(a,b,d){a=f.createRevokeVoiceQuery(a,b,d);e.getConnection().sendIQ(a,function(){})},grantVoice:function(a,b,d){a=f.createGrantVoiceQuery(a,b,d);e.getConnection().sendIQ(a,
function(){})},fetchRoster:function(){return e.createIqResponseObservable(f.createRosterQuery()).map(c.mapRosterXmlToJson)},getCurrentUserId:function(){return b.get("jabber_id")}};return e}]);angular.module("utility").service("chatServerHelper",["strophe",function(c){var f={mapPubSubRoomItemToJson:function(b,d){var a=c.getChild(b,"purpose");return{id:b.getAttribute("id"),purpose:c.getChild(a,"value").textContent,course:d.split("/")[0],cohort:d.split("/")[1]}},mapPubSubRoomAtNodesResult:function(b){if(b=c.getChild(b,"items")){var d=b.getAttribute("node");return _.chain(b.childNodes).filter(f.filterRoomNode).map(function(a){return f.mapPubSubRoomItemToJson(a,d)}).value()}console.warn("no items element in pubsub response")},
mapPubSubRoomNodeUpdate:function(b){var d=c.getChild(b,"items").getAttribute("node"),b=c.getChild(b,"item");return[f.mapPubSubRoomItemToJson(b,d)]},getConfiguredRoomId:function(b){return function(d){return"error"===d.getAttribute("type")?(console.warn("bad configurations passed in"),null):b}},createPathString:function(b,d){return"public"===b?"public":b+"/"+d},filterNoConfigPossibleStanza:function(b,d){return f.filterStanza(b,"iq",{from:d,type:"result"},["query"])&&0===c.getChild(b,"query").childElementCount},
filterRoomNode:function(b){return f.filterStanza(b,"item",{},["entry"])&&b.getAttribute("id")&&c.getChild(b,"entry")&&c.getChild(c.getChild(b,"entry"),"purpose")},filterPubsubUpdateHasRoomNodeUpdate:function(b){return(b=c.getChild(b,"item"))&&f.filterRoomNode(b)},filterRoomJoinedFailedStanza:function(b){return f.filterStanza(b,"presence",{type:"error"},["x","error"])&&f.filterStanza(c.getChild(b,"error"),"error",{type:"cancel"},["service-unavailable"])},filterNoBookmarkNodeStanza:function(b){return f.filterStanza(b,
"iq",{type:"error"},["error","pubsub"])&&f.filterStanza(c.getChild(b,"error"),"error",{code:"404",type:"cancel"},["item-not-found"])},filterPubsubStanza:function(b){return f.filterStanza(b,"iq",{type:"result",from:c.getPubsubDomain()},["pubsub"])&&f.filterStanza(c.getChild(b,"pubsub"),"pubsub",{xmlns:"http://jabber.org/protocol/pubsub"},["items"])},filterStanza:function(b,d,a,c){if(!b)return!1;var d=d?b.tagName.toLowerCase()===d:!0,f=0===_.filter(_.keys(a),function(d){return"string"===typeof b.getAttribute(d)?
b.getAttribute(d).toLowerCase()!==a[d].toLowerCase():b.getAttribute(d)!==a[d]}).length,c=0===_.filter(c,function(a){return 0===b.getElementsByTagName(a).length}).length;return d&&f&&c},filterDirectChatStanzas:function(b){return f.filterStanza(b,"message",{type:"chat"},["body"])},filterRoomChatStanzas:function(b){return f.filterStanza(b,"message",{type:"groupchat"},["body"])&&!f.filterStanza(c.getChild(b,"status"),"status",{code:"100"},[])},filterRoomPresenceStanzas:function(b){return f.filterStanza(b,
"presence",{},["x"])&&f.filterStanza(c.getChild(b,"x"),"x",{xmlns:"http://jabber.org/protocol/muc#user"},["item"])},filterItemNotFoundStanza:function(b){return f.filterStanza(b,"iq",{type:"error"},["error","pubsub"])&&f.filterStanza(c.getChild(b,"error"),"error",{type:"cancel"},["item-not-found"])},filterRoomJoinedJson:function(b){return"110"===b.status},filterGlobalPresenceStanzas:function(b){return f.filterStanza(b,{name:"presence",xmlns:null})},filterMaxUsersInRoomError:function(b,d){return f.filterStanza(b,
"presence",{from:c.getJabberIdForUserInRoom(d),type:"error"},["x","error"])&&f.filterStanza(c.getChild(b,"error"),"error",{by:d,type:"cancel"},["not-acceptable"])},filterPubSubUpdateForNode:function(b){return function(d){return f.filterStanza(d,"message",{from:c.getPubsubDomain()},["event"])&&f.filterStanza(c.getChild(d,"items"),"items",{node:b},["item"])&&!c.getChild(d,"delay")}},filterRoomCreatedStanzas:function(b){return function(d){var a=c.getChild(d,"x"),h=null;a&&(h=c.getChild(a,"item"));return a&&
h&&f.filterStanza(d,"presence",{from:c.getJabberIdForUserInRoom(b)},["x"])&&f.filterStanza(a,"x",{xmlns:"http://jabber.org/protocol/muc#user"},["item","status"])&&f.filterStanza(c.getChild(a,"status"),"status",{code:"110"},[])&&"owner"===h.getAttribute("affiliation")}},filterErrorStanzas:function(b){return f.filterStanza(b,"error",{},[])||f.filterStanza(b,null,{type:"error"},[])},mapDirectChatXmlToJson:function(b){return{from:c.getBareJid(b.getAttribute("from")),to:c.getBareJid(b.getAttribute("to")),
body:c.getChildText(b,"body"),date:c.getDate(b)}},mapRoomChatXmlToJson:function(b){return{from:b.getAttribute("fullid")||c.getUserNameFromRoomJid(b.getAttribute("from")),roomId:c.getBareJid(b.getAttribute("from")),to:c.getBareJid(b.getAttribute("to")),body:c.getChildText(b,"body"),date:c.getDate(b)}},mapRoomJoinedFailedXmlToJson:function(b){return{id:c.getBareJid(b.getAttribute("from")),code:c.getChild(b,"error").getAttribute("code")}},mapRoomPresenceXmlToJson:function(b){var d=null,a=null,h=null,
f=null,j=null,e=c.getChild(b,"status");e&&(d=e.getAttribute("code"));if(e=c.getChild(b,"item"))a=e.getAttribute("affiliation"),h=e.getAttribute("role"),f=c.getDomainFromJid(e.getAttribute("jid")),j=c.getBareJid(e.getAttribute("jid"));return{user:j,roomId:c.getBareJid(b.getAttribute("from")),type:b.getAttribute("type"),status:d,role:h,affiliation:a,domain:f,show:c.getChildText(b,"show"),isCurrentUser:"110"===c.getStatusCode(b)}},mapGlobalPresenceXmlToJson:function(b){return{user:b.getAttribute("from"),
type:b.getAttribute("type")||"available",status:c.getChildText(b,"status"),show:c.getChildText(b,"show")}},mapErrorXmlToJson:function(b){return{message:(new XMLSerializer).serializeToString(b)}},mapRosterXmlToJson:function(b){if(b=c.getChild(b,"query"))return b=b.getElementsByTagName("item"),_.map(b,function(b){return{id:b.getAttribute("jid"),name:b.getAttribute("name"),subscription:b.getAttribute("subscription"),group:c.getChildText(b,"group")}})},mapOpenRoomsXmlToJson:function(b){b=b.getElementsByTagName("item");
return _.map(b,function(b){return{id:b.getAttribute("jid"),name:b.getAttribute("name")}})},combineRoomAndBookmarkLists:function(b){var d=b.bookmarkList;return _.map(b.roomList,function(a){var b=!1;_.contains(_.map(d,function(a){return a.id}),a.id)&&(b=!0);return _.extend(a,{isBookmarked:b})})},mapBookmarksXmlToJson:function(b){if(f.filterNoBookmarkNodeStanza(b))return[];b=c.getChild(b,"storage");return _.chain(b.childNodes).filter(function(b){return"conference"===b.tagName.toLowerCase()}).map(function(b){return{name:b.getAttribute("name"),
id:b.getAttribute("id")}}).value()},mapRoomInfoQueryResponseXmlToJson:function(b){var d=c.getChild(b,"identity"),a=_.chain(_.range(d.attributes.length)).map(function(a){return d.attributes[a].nodeName}).value(),a=_.object(a,_.map(a,function(a){return d.getAttribute(a)})),b=c.getChild(b,"x"),h={};b&&b.childNodes&&(b=_.filter(b.childNodes,function(a){return"field"===a.tagName.toLowerCase()&&a.getAttribute("label")}),h=_.object(_.map(b,function(a){return c.getRoomInfoToAttributesMap()[a.getAttribute("var")]}),
_.map(b,function(a){return c.getChildText(a,"value")})));h.numOccupants&&(h.numOccupants=parseInt(h.numOccupants));return _.extend(a,h)}};return f}]);angular.module("utility").directive("createChatGroupModal",["cacheVersion","chatDataStore","modal","chatForm","$timeout",function(c,f,b,d,a){return{templateUrl:"/templates/chat/create_chat_group_modal.html?"+c,link:function(c){c.groups=f.getRooms();var i=_.throttle(function(){a(angular.noop)},10);d.resetInvalidFields();d.clearSubmissionResults();c.invalidFields=d.invalidFields;c.isInGroup=function(a){if(a)return f.hasBookmark(a.id)};c.joinGroupAndChangeModal=function(a){b.confirm();c.openChatGroupListModal();
f.joinRoom(a)};c.createRoom=function(a,e,k){d.checkForInvalidFields(a,e,k)||("topic"===k?(f.createRoom({roomName:a,description:e,membersOnly:0},"nd001","public","topic"),c.groupType="topic"):(f.createRoom({roomName:a,description:e,membersOnly:0},"nd001","public","study"),c.groupType="study"),b.confirm(),c.openChatGroupListModal(),i())}}}}]);angular.module("utility").directive("editGroupDescription",["cacheVersion","$timeout","$filter",function(c,f,b){return{templateUrl:"/templates/chat/edit_group_description.html?"+c,link:function(d,a){var c=_.throttle(function(){f(angular.noop)},1E3);d.suggestionsView={close:!1,groupNameInputHasFocus:!1};a.find("#name").focus(function(){d.suggestionsView.groupNameInputHasFocus=!0;d.suggestionsView.close=!1;c()});a.find("#name").blur(function(){d.suggestionsView.groupNameInputHasFocus=!1;c()});d.showSuggestions=
function(){d.suggestions=b("filter")(_.values(d.groups),d.newAttributes.groupName);return d.newAttributes.groupName&&d.suggestionsView.groupNameInputHasFocus&&!d.suggestionsView.close&&0<d.suggestions.length}}}}]);angular.module("utility").directive("editChatGroupModal",["cacheVersion","chatDataStore","modal","$timeout","chatForm",function(c,f,b,d,a){return{templateUrl:"/templates/chat/edit_chat_group_modal.html?"+c,link:function(c){c.invalidFields=a.invalidFields;c.editedGroup=f.getEditedRoom();var i=_.throttle(function(){d(angular.noop)},1E3);c.newAttributes={groupName:null,description:null};c.$watch("editedGroup.currentlyEditing",function(){if(!_.isEmpty(c.editedGroup.currentlyEditing)){var a=c.editedGroup.currentlyEditing;
c.newAttributes.groupName=a.name;c.newAttributes.description=a.description;c.groupId=a.id;i()}});c.editGroup=function(){var d={roomName:c.newAttributes.groupName,description:c.newAttributes.description};a.checkForInvalidFields(d.roomName,d.description,!0)||(f.editRoom(d,c.groupId),b.confirm(),c.openChatGroupListModal())}}}}]);angular.module("utility").directive("groupChat",["cacheVersion","$window","chatDataStore","modal","api","currentUser","chatForm","$timeout","showChat","notifications",function(c,f,b,d,a,h,i,j,e,k){return{templateUrl:"/templates/chat/group_chat.html?"+c,link:function(a){var c=_.throttle(function(){j(angular.noop)},10),f=!1;a.showGroupChat=!1;k.registerNotificationCreator("chat","noisy");e.getGroupChatPromise().then(function(c){a.showGroupChat=c;a.showGroupChat&&!f&&(b.init(),h.checkIfFirstChatVisit().then(function(b){0<
b.data.tags_added.length?(a.isFirstVisit=!0,a.inIntroFlow=!0,d.activate("introToChatModal").then(function(){},function(){a.inIntroFlow=!1})):(a.isFirstVisit=!1,a.inIntroFlow=!1);return!0}),f=!0)});a.showChat=!1;a.isStaff=h.isStaff;a.isFirstVisit=!0;a.inIntroFlow=!0;a.showChatWidget=function(){return!1===a.inIntroFlow||!1===a.isFirstVisit};a.groupType="topic";a.openChatGroupListModal=function(){d.activate("chatGroupListModal").then(function(){i.clearSubmissionResults()},function(){i.clearSubmissionResults();
a.inIntroFlow=!1})};a.showCreateGroupModal=function(){d.activate("createChatGroupModal").then(function(){},function(){a.inIntroFlow=!1})};a.showGetStartedModal=function(){d.activate("getStartedModal").then(function(){a.inIntroFlow=!1},function(){a.inIntroFlow=!1})};a.showEditGroupModal=function(c){b.setEditedRoom(c);d.activate("editChatGroupModal").then(function(){},function(){a.inIntroFlow=!1})};a.notifications=b.getNotifications();a.markRead=function(){a.notifications.hasUnreadMessages=!1};a.toggleChat=
function(){a.showChat=!a.showChat;a.markRead();c()};a.openChannelIds=b.getOpenChannels();a.getNumOpenChannels=function(){return _.size(a.openChannelIds)};a.activateChatGroupListModal=function(b){d.confirm();a.groupType=b;a.openChatGroupListModal()};a.activateAllSetModal=function(){d.activate("allSetModal").then(function(){a.inIntroFlow=!1},function(){a.inIntroFlow=!1})}}}}]).directive("chatWidget",["cacheVersion",function(c){return{templateUrl:"/templates/chat/chat_widget.html?"+c,link:function(){}}}]);angular.module("utility").directive("introToChatModal",["cacheVersion","modal",function(c){return{templateUrl:"/templates/chat/intro_to_chat_modal.html?"+c,link:function(){}}}]);angular.module("utility").service("strophe",["currentUser","dateTime",function(c,f){var b={};b[Strophe.Status.ERROR]="error";b[Strophe.Status.CONNECTING]="connecting";b[Strophe.Status.AUTHENTICATING]="connecting";b[Strophe.Status.CONNECTED]="connected";b[Strophe.Status.CONNFAIL]="connection failed";b[Strophe.Status.AUTHFAIL]="connection failed";b[Strophe.Status.DISCONNECTED]="disconnected";b[Strophe.Status.DISCONNECTING]="disconnecting";b[Strophe.Status.ATTACHED]="attached";var d={getJabberId:function(){return c.get("jabber_id")},
getConnectionStatus:function(a){return b[a]},getBareJid:function(a){if(a)return Strophe.getBareJidFromJid(a)},getDomainFromJid:function(a){if(a)return Strophe.getDomainFromJid(a)},getNodeFromJid:function(a){if(a)return Strophe.getNodeFromJid(a)},getRoomDomain:function(){return"conference.udacity.com"},getRoomJid:function(a){return a+"@"+d.getRoomDomain()},getUserNameFromRoomJid:function(a){return 0<a.split("/").length?a.split("/")[1]:null},createAvailablePresence:function(){return $pres().c("x",{xmlns:"http://jabber.org/protocol/muc"},
"").tree()},getNickNameFromJabberId:function(a){if(a)return Strophe.getNodeFromJid(a)},getJabberIdForUserInRoom:function(a){return a+"/"+d.getNickName()},getPubsubDomain:function(){return"pubsub.udacity.com"},isRoomId:function(a){return Strophe.getDomainFromJid(a)===d.getRoomDomain()},getRoomInfoToAttributesMap:function(){return{"muc#roominfo_description":"description","muc#roominfo_subject":"subject","muc#roomconfig_changesubject":"allowChangeSubject","muc#roominfo_occupants":"numOccupants","muc#roominfo_lang":"language",
"muc#maxhistoryfetch":"maxHistory","muc#roominfo_pubsub":"pubsub"}},getRoomAttributesToMucAttributesMap:function(){return{roomName:"muc#roomconfig_roomname",description:"muc#roomconfig_roomdesc",language:"muc#roomconfig_lang",logging:"muc#roomconfig_enablelogging",allowChangeSubject:"muc#roomconfig_changesubject",allowInvites:"muc#roomconfig_allowinvites",allowPrivateMessages:"muc#roomconfig_allowpm",maxUsers:"muc#roomconfig_maxusers",rolesForPresenceBroadcast:"muc#roomconfig_presencebroadcast",rolesThatCanGetMemberList:"muc#roomconfig_getmemberlist",
publiclySearchable:"muc#roomconfig_publicroom",persistent:"muc#roomconfig_persistentroom",moderated:"muc#roomconfig_moderatedroom",membersOnly:"muc#roomconfig_membersonly",passwordRequired:"muc#roomconfig_passwordprotectedroom",password:"muc#roomconfig_roomsecret",whoCanDiscoverRealJabberIds:"muc#roomconfig_whois",maxHistory:"muc#maxhistoryfetch",additionalRoomAdmins:"muc#roomconfig_roomadmins",additionalRoomOwners:"muc#roomconfig_roomowners"}},mapRoomAttributes:function(a){var b=d.getRoomAttributesToMucAttributesMap();
return _.object(_.map(_.keys(a),function(a){return b[a]}),_.map(_.values(a),function(a){return null===a?"none":String(a)}))},createRosterQuery:function(){return $iq({from:d.getJabberId(),type:"get",id:"roster"}).c("query",{xmlns:"jabber:iq:roster"}).tree()},createNewRoomPresenceElement:function(a){a={from:d.getJabberId(),to:d.getJabberIdForUserInRoom(a)};return $pres(a).c("x",{xmlns:"http://jabber.org/protocol/muc"}).tree()},getRoomJabberIdFromRoomName:function(a){var a=a.replace(/[\~\!\*\(\)\'\s]/g,
""),b=_.chain(_.range(0,5)).map(function(){return String.fromCharCode(65+Math.floor(26*Math.random()))}).reduce(function(a,b){return a.concat(b)},"").value();return encodeURI(a)+"-"+Date.now()+b+"@"+d.getRoomDomain()},createNewInstantRoomQueryElement:function(a){var a={from:d.getJabberId(),to:d.getJabberIdForUserInRoom(d.getRoomJabberIdFromRoomName(a)),type:"set"},b=$q({xmlns:"http://jabber.org/protocol/muc#owner"}),c=$build("x",{xmlns:"jabber:x:data",type:"submit"});b.appendChild(c);return $iq(a).c(b).tree()},
createRequestConfigFormQueryElement:function(a){return $iq({from:d.getJabberId(),to:a,type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).tree()},createGetBookmarksIqElement:function(){return $iq({from:d.getJabberId(),type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("items",{node:"storage:bookmarks"}).tree()},createDeleteRoomIqElement:function(a){return $iq({from:d.getJabberId(),to:a,type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).c("destroy").tree()},
createDeletePubsubItemElement:function(a,b){return $iq({type:"set",from:d.getJabberId(),to:d.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("retract",{node:a}).c("item",{id:b}).tree()},createUploadBookmarksIqElement:function(a){return d.createUploadDataIqElement("storage:bookmarks",d.createRoomBookmarkItems(a))},createUploadRoomAccessItem:function(a,b){return $build("item",{id:b}).c("entry",{xmlns:"http://www.w3.org/2005/Atom"}).c("purpose",{}).c("value",{},a).tree()},
createConfiguredNodeElement:function(a){return $iq({type:"set",from:d.getJabberId(),to:d.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("create",{node:a}).up().c("configure").c("x",{xmlns:"jabber:x:data",type:"submit"}).c("field",{"var":"FORM_TYPE",type:"hidden"}).c("value",{},"http://jabber.org/protocol/pubsub#node_config").up().c("field",{"var":"pubsub#access_model"}).c("value",{},"open").up().c("field",{"var":"pubsub#publish_model"}).c("value",{},"open").tree()},
createUploadRoomAccessIqElement:function(a,b,c){return d.createUploadDataIqElement(a,d.createUploadRoomAccessItem(b,c),d.getPubsubDomain())},createSubscribeToPubsubNodeElement:function(a){return $iq({type:"set",from:d.getJabberId(),to:d.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:a,jid:d.getJabberId()}).tree()},createRoomInfoQuery:function(a){return $build("iq",{from:d.getJabberId(),to:a,type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#info"}).tree()},
createGetRoomAtNodesIqElement:function(a){return $iq({type:"get",from:d.getJabberId(),to:d.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("items",{node:a}).tree()},createUploadDataIqElement:function(a,b,c){var f={from:d.getJabberId(),type:"set"};c&&(f.to=c);var a=$iq(f).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("publish",{node:a}).cnode(b).up().up(),e=$build("x",{xmlns:"jabber:x:data",type:"submit"}),b=[$build("field",{"var":"FORM_TYPE",type:"hidden"}).c("value",
{},"http://jabber.org/protocol/pubsub#publish-options").up(),$build("field",{"var":"pubsub#persist_items"}).c("value",{},"true").up()];_.forEach(b,function(a){e.cnode(a.tree()).up()});b=$build("publish-options",{}).cnode(e.tree()).up();a.cnode(b.tree());return a.tree()},createRoomBookmarkItems:function(a){var a=_.map(a,function(a){return $build("conference",{name:a.name,autojoin:"true",jid:a.id,id:a.id}).tree()}),b=$build("storage",{xmlns:"storage:bookmarks"});_.forEach(a,function(a){b.cnode(a).up()});
b.c("nick",{},d.getNickName());return $build("item",{id:"current"}).cnode(b.tree()).tree()},createNewConfiguredRoomQueryElement:function(a,b){var c=_.map(d.mapRoomAttributes(a),function(a,b){return $build("field",{"var":b}).c("value",{},a).tree()}),f=$build("x",{xmlns:"jabber:x:data",type:"submit"});f.cnode($build("field",{"var":"FORM_TYPE"}).c("value",{},"http://jabber.org/protocol/muc#roomconfig").tree()).up();_.forEach(c,function(a){a&&f.cnode(a).up()});c=$build("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).cnode(f.tree()).tree();
return $build("iq",{from:d.getJabberId(),to:b,type:"set"}).cnode(c).tree()},createUnavailablePresenceElement:function(){return $pres({from:d.getJabberId(),type:"unavailable"}).tree()},createJoinRoomPresenceElement:function(a){var a={from:d.getJabberId(),to:d.getJabberIdForUserInRoom(a)},b=$build("x",{xmlns:"http://jabber.org/protocol/muc"}).tree();return $pres(a).cnode(b).tree()},createLeaveRoomPresenceElement:function(a){a={from:d.getJabberId(),to:d.getJabberIdForUserInRoom(a),type:"unavailable"};
return $pres(a).tree()},createRoomChatMessageElement:function(a,b){return $msg({to:a,from:d.getJabberId(),type:"groupchat",fullid:d.getJabberId()}).c("body",{},b).tree()},createDirectMessageElement:function(a,b){return $msg({to:a,from:d.getJabberId(),type:"chat"}).c("body",{},b).tree()},createOpenRoomsQuery:function(){return $iq({from:d.getJabberId(),to:"conference.udacity.com",type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"}).tree()},getNickName:function(){if(d.getJabberId())return Strophe.getNodeFromJid(d.getJabberId())},
getUserNameInRoom:function(a){if(a)return Strophe.getResourceFromJid(a)},getRoomName:function(a){if(a)return Strophe.getNodeFromJid(a)},createXmppServerConnection:function(){return new Strophe.Connection("https://rumours.udacity.com:5280/http-bind")},getServerBaseUrl:function(){return"https://rumours.udacity.com:5280"},getStatusCode:function(a){return(a=d.getChild(a,"x"))&&d.getChild(a,"status")?d.getChild(a,"status").getAttribute("code"):null},subscribeToPubsubNode:function(a){return $iq({type:"set",
to:d.getPubsubDomain(),from:d.getJabberId()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:a,jid:d.getJabberId()}).tree()},getChild:function(a,b){if(a.hasChildNodes()){var c=a.getElementsByTagName(b);return 0<c.length?c[0]:_.find(_.map(a.childNodes,function(a){return d.getChild(a,b)}),function(a){return null!==a})}return null},getChildText:function(a,b){var c=d.getChild(a,b);return c?Strophe.getText(c):null},getDate:function(a){var b=f.getCurrent(),a=a.getElementsByTagName("delay");
0<a.length&&"urn:xmpp:delay"===a[0].getAttribute("xmlns")&&(b=a[0].getAttribute("stamp"),b=new Date(b));return b}};return d}]);
